<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-the-five-rules-of-event-sourcing">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">üñê The 5 Rules of Event Sourcing | Castore</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://castore-dev.github.io/castore/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://castore-dev.github.io/castore/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://castore-dev.github.io/castore/docs/the-five-rules-of-event-sourcing/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="üñê The 5 Rules of Event Sourcing | Castore"><meta data-rh="true" name="description" content="1 - Do not use read models to validate your commands"><meta data-rh="true" property="og:description" content="1 - Do not use read models to validate your commands"><link data-rh="true" rel="icon" href="/castore/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://castore-dev.github.io/castore/docs/the-five-rules-of-event-sourcing/"><link data-rh="true" rel="alternate" href="https://castore-dev.github.io/castore/docs/the-five-rules-of-event-sourcing/" hreflang="en"><link data-rh="true" rel="alternate" href="https://castore-dev.github.io/castore/docs/the-five-rules-of-event-sourcing/" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/castore/blog/rss.xml" title="Castore RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/castore/blog/atom.xml" title="Castore Atom Feed"><link rel="stylesheet" href="/castore/assets/css/styles.c5676a11.css">
<link rel="preload" href="/castore/assets/js/runtime~main.e224adbb.js" as="script">
<link rel="preload" href="/castore/assets/js/main.adec9fa8.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_oPtH" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/castore/"><div class="navbar__logo"><img src="/castore/img/logo.svg" alt="Castore Logo" class="themedImage_BQGR themedImage--light_HAxW"><img src="/castore/img/logo.svg" alt="Castore Logo" class="themedImage_BQGR themedImage--dark_bGx0"></div><b class="navbar__title text--truncate">Castore</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/castore/docs/intro/">Tutorial</a><a class="navbar__item navbar__link" href="/castore/blog/">Blog</a><a class="navbar__item navbar__link" href="/castore/visualizer/">Visualizer</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/castore-dev/castore" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPrP"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_ki11 colorModeToggle_Hewu"><button class="clean-btn toggleButton_MMFG toggleButtonDisabled_Uw7m" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_lgto"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_U96C"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_WqAV"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_MB5r docsWrapper_ct1J"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_iEvu" type="button"></button><div class="docPage_KLoz"><aside class="theme-doc-sidebar-container docSidebarContainer_y0RQ"><div class="sidebarViewport_EJ1r"><div class="sidebar_CUen"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_jmj1"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/castore/docs/intro/">Tutorial Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/castore/docs/category/tutorial---basics/">Tutorial - Basics</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tutorial - Basics&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/castore/docs/category/tutorial---extras/">Tutorial - Extras</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tutorial - Extras&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/castore/docs/building-your-own-event-storage-adapter/">Building your own EventStorageAdapter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/castore/docs/the-five-rules-of-event-sourcing/">üñê The 5 Rules of Event Sourcing</a></li></ul></nav></div></div></aside><main class="docMainContainer_sTIZ"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_Qr34"><div class="docItemContainer_tjFy"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_T5ub" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/castore/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_sfvy"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">üñê The 5 Rules of Event Sourcing</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_wXna theme-doc-toc-mobile tocMobile_Ojys"><button type="button" class="clean-btn tocCollapsibleButton_iI2p">On this page</button></div><div class="theme-doc-markdown markdown"><h1>üñê The 5 Rules of Event Sourcing</h1><h2 class="anchor anchorWithStickyNavbar_JmGV" id="1---do-not-use-read-models-to-validate-your-commands">1 - Do not use read models to validate your commands<a href="#1---do-not-use-read-models-to-validate-your-commands" class="hash-link" aria-label="Direct link to 1 - Do not use read models to validate your commands" title="Direct link to 1 - Do not use read models to validate your commands">‚Äã</a></h2><p>Read models are only for read, not for write. They are like cache: Thrashable, re-computable. The events are your source of truth: Use them when you want to validate a command input.</p><h2 class="anchor anchorWithStickyNavbar_JmGV" id="2---write-only-at-present-tense">2 - Write only at present tense<a href="#2---write-only-at-present-tense" class="hash-link" aria-label="Direct link to 2 - Write only at present tense" title="Direct link to 2 - Write only at present tense">‚Äã</a></h2><p>You MUST NOT write events in the past. Instead, you should write a real-time event, with the current timestamp, that contains information on the future or past events.</p><p>You can use the entity <a href="#%E2%8F%B0-timeline">simulator</a> to simulate the side-effects of such event on the aggregate.</p><h2 class="anchor anchorWithStickyNavbar_JmGV" id="3---do-not-write-several-events-on-the-same-aggregate-in-one-command">3 - Do not write several events on the same aggregate in one command<a href="#3---do-not-write-several-events-on-the-same-aggregate-in-one-command" class="hash-link" aria-label="Direct link to 3 - Do not write several events on the same aggregate in one command" title="Direct link to 3 - Do not write several events on the same aggregate in one command">‚Äã</a></h2><p>Say that you have <code>ORDER_CREATED</code> and <code>PRODUCT_ATTACHED_TO_ORDER</code> events already, and you now want an &quot;order&quot; to be automatically created when a user selects a &quot;product&quot;. You may be tempted to re-use those events in your command, on a new &quot;order&quot; aggregate:</p><ul><li>1: <code>ORDER_CREATED</code> (2022-01-01T00:00:00.000Z)</li><li>2: <code>PRODUCT_ATTACHED_TO_ORDER</code> (2022-01-01T00:00:00.000Z)</li></ul><p>However, this is not recommended. Depending on your system, your projectors and reactions down the line may not be able to process your events correctly, or in the correct order, which could lead to bugs.</p><p>You should rather modify your <code>ORDER_CREATED</code> event to optionally contain a <code>attachedProductId</code>, or create a new event entirely.</p><h2 class="anchor anchorWithStickyNavbar_JmGV" id="4---write-relations-on-all-sides">4 - Write relations on all sides<a href="#4---write-relations-on-all-sides" class="hash-link" aria-label="Direct link to 4 - Write relations on all sides" title="Direct link to 4 - Write relations on all sides">‚Äã</a></h2><p>In general, creating a relation in one way, say from an &quot;order&quot; to many &quot;products&quot;, is easy to do: Simply write the &quot;order&quot; id on the &quot;product&quot; initial event. However, in the context of a command (remember that you can&#x27;t use read models, that can easily re-index), the other way around is tricky: Depending on your implementation (especially in NoSQL), there may not be an easy way to find all the &quot;products&quot; of an &quot;order&quot;.</p><p>The solution is to write an attachment event on the &quot;order&quot; at the same time that the &quot;product&quot; is created, containing only its order id. This way, you can easily find the order products ids in its aggregate. However, make sure to use transactions: Either all events are written, either none of them is written.</p><h2 class="anchor anchorWithStickyNavbar_JmGV" id="5---think-of-re-playability--in-projections-dont-cross-the-streams">5 - Think of re-playability ! In projections, <a href="https://www.youtube.com/watch?v=wyKQe_i9yyo" target="_blank" rel="noopener noreferrer">don&#x27;t cross the streams</a><a href="#5---think-of-re-playability--in-projections-dont-cross-the-streams" class="hash-link" aria-label="Direct link to 5---think-of-re-playability--in-projections-dont-cross-the-streams" title="Direct link to 5---think-of-re-playability--in-projections-dont-cross-the-streams">‚Äã</a></h2><p>Events should easily be re-played to re-compute projections.</p><p>Crossing aggregates in your projection is ‚ùå dangerous ‚ùå It makes re-playability so much harder, because you won&#x27;t be able to replay an aggregate in isolation!</p><p>If you need to display data from several aggregates in a page, simply use several read models, but DO NOT CROSS entities in your projector (you&#x27;ll notice that it is not doable in this prototype, by design).</p><p>For the same reason:</p><ul><li>DO NOT project events from several aggregates, even from the same entity, on the same read model (keep a 1-to-1 mapping and not a N-to-1).</li><li>DO NOT use the data from read models other than the one being updated. And, to avoid race conditions, keep your read model updates as single-transactions (for instance, using <code>append</code> operators, or <code>conditions</code>) instead of getting and re-pushing.</li></ul><h1>‚è∞ Timeline</h1><p>The second rule states that you should always write event at present tense. However, certain events may have side-effects in time. For instance:</p><ul><li>Your event may mean that another event should have been recorded in the past (retroactive event)</li><li>Your event may mean that an event will probably appear at a given date in the future (like an offer expiry).</li></ul><p>However, you can, theoretically, already know from the recorded events if such &quot;side-effect&quot; events are allowed or not ! Wouldn&#x27;t that be neat to disallow them from the get-go, in the command ?</p><p>Well, now you can ü•≥ That&#x27;s the goal of the <code>simulator</code> property of entities.</p><p>A simulator is a reducer: It takes a dictionnary of events (indexed by the index of your choice) and a recorded event, and outputs another dictionnary of events. The default simulators simply adds the recorded event to the dictionary, indexing it by its version.</p><p>Simulators are used by the <code>simulateAggregate</code> method exposed in the entities states. The logic for simulating the aggregate is the following:</p><ul><li>Apply the simulator to the aggregate events, starting with an empty object.</li><li>Get the resulting events, sort them by timestamp and filter out the events that are after the provided <code>simulationDate</code></li><li>Replace the event versions by their index in the resulting simulated history</li><li>Apply the entity reducer to the simulated event history</li></ul><p>You can find an implementation of this in this project (example stack):</p><ul><li>A <code>/plan-counter-removal</code> command will add <code>COUNTER_REMOVAL_PLANNED</code> event to the counter event history</li><li>In the simulator, this event will add a simulated <code>COUNTER_REMOVED</code> event to the aggregate history at a future date (index by its version concatenated with <code>#1</code>)</li><li>This fictional event will also be removed by the simulator from the simulated aggregate history by any <code>COUNTER_REMOVED</code> events that is actually the result of this planification (to prevent having 2 <code>COUNTER_REMOVED</code> events in the simulated history once the date is past)</li><li>When planning another removal, or an increment, the <code>simulateAggregate</code> method is used to prevent the planification if the aggregate is projected to have a <code>REMOVED</code> status at this date ü•≥</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/castor-dev/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/the-five-rules-of-event-sourcing.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_bHB7" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_pbO5"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/castore/docs/building-your-own-event-storage-adapter/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Building your own EventStorageAdapter</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_XG6w thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1---do-not-use-read-models-to-validate-your-commands" class="table-of-contents__link toc-highlight">1 - Do not use read models to validate your commands</a></li><li><a href="#2---write-only-at-present-tense" class="table-of-contents__link toc-highlight">2 - Write only at present tense</a></li><li><a href="#3---do-not-write-several-events-on-the-same-aggregate-in-one-command" class="table-of-contents__link toc-highlight">3 - Do not write several events on the same aggregate in one command</a></li><li><a href="#4---write-relations-on-all-sides" class="table-of-contents__link toc-highlight">4 - Write relations on all sides</a></li><li><a href="#5---think-of-re-playability--in-projections-dont-cross-the-streams" class="table-of-contents__link toc-highlight">5 - Think of re-playability ! In projections, don&#39;t cross the streams</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/castore/docs/intro/">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/castore-dev/castore" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPrP"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2023 Castore, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/castore/assets/js/runtime~main.e224adbb.js"></script>
<script src="/castore/assets/js/main.adec9fa8.js"></script>
</body>
</html>